/*! minnpost-temperature-record-breaking-2012 - v0.0.1 - 2013-08-26
* Copyright (c) 2013 ; Licensed  */

String.prototype.capitalize=function(){return this.replace(/(^|\s)([a-z])/g,function(a,b,c){return b+c.toUpperCase()})},function(a){window.mpTempApp=function(b){function c(b){var c=!1,d=[];return b=_.isArray(b)?b:[b],0===f.indexOf("http")&&(c=!0),_.each(b,function(b){var h;_.isUndefined(g[b])&&(h=c?a.jsonp({url:e+encodeURI(f+b+".json")}):a.getJSON(f+b+".json"),a.when(h).done(function(a){g[b]=a}),d.push(h))}),a.when.apply(a,d)}function d(){function b(a,b){var c;for(c in b)if(b[c].station_name==a)return b[c];return{}}var c=g["noaa-mi3-station-data-mn-trimmed"],d=g["broken_temperature_record_from_pbs-2012-mn"];d.sort(function(a,b){var c=(""+a.record_date).toLowerCase(),d=(""+b.record_date).toLowerCase();return c>d?1:d>c?-1:0});var e={},f=0,h={};for(var i in d)if(d[i].record_date){var j=Date.parse(d[i].record_date),k=Date.parse(d[i].previous_record_date);"undefined"==typeof e[d[i].record_date]&&(e[d[i].record_date]={}),e[d[i].record_date].date=j,e[d[i].record_date].date_formatted=j.toString("MMM d"),e[d[i].record_date].date_object=j;var l=b(d[i].station_name,c),m=(d[i].record-d[i].previous_record)/d[i].previous_record+.01;e[d[i].record_date].places=e[d[i].record_date].places||[];var n={name:d[i].station_name.toLowerCase().capitalize().replace("Ap","Airport"),lat:l.lat,lon:l.lon,record:d[i].record,previous_record:d[i].previous_record,previous_record_date:k,difference:m,date:j};e[d[i].record_date].places.push(n),m>f&&(f=m,h=n)}var o=new L.TileLayer("http://{s}.tiles.mapbox.com/v3/minnpost.map-wi88b700/{z}/{x}/{y}.png",{attribution:"Map imagery from <a href=http://mapbox.com'>Mapbox</a>",subdomains:["a","b","c","d"],maxZoom:8,minZoom:4}),p=new L.Map("temperature-map",{center:new L.LatLng(46.479553,-93.98589980000003),zoom:7,layers:[o]}),q={color:"#801019",fillColor:"#801019",fillOpacity:.7,stroke:!1},r=function(a){var b="";return b+="<h3>"+a.date_object.toString("MMM d, yyyy")+"</h3>",b+="<ul>",_.each(a.places,function(c,d){b+="<li>"+a.places[d].name+": <br> <strong>"+a.places[d].record+" &deg;F</strong> &nbsp;&nbsp;("+a.places[d].previous_record+" &deg;F in "+a.places[d].previous_record_date.toString("yyyy")+")</li>"}),b+="</ul>"},s=function(a,b){var c="";return c+='<div class="popup-heading">'+a.name+"</div>",c+='<div class="popup-date">Date: <strong>'+b.toString("MMM d, yyyy")+"</strong></div>",c+='<div class="popup-new-record">New record: <strong>'+a.record+" &deg;F</strong></div>",c+='<div class="popup-previous-record">Previous record: <strong>'+a.previous_record+" &deg;F</strong> on <strong>"+a.previous_record_date.toString("yyyy")+"</strong></div>"},t={},u=[];_.each(e,function(a,b){var c=new L.LayerGroup;u.push(b),_.each(e[b].places,function(a,d){var g=e[b].places[d].difference/f,h=1e4+3e4*g,i=new L.Circle(new L.LatLng(e[b].places[d].lat,e[b].places[d].lon),h,q);i.bindPopup(s(e[b].places[d],e[b].date_object)),c.addLayer(i)}),p.addLayer(c),t[e[b].date_formatted+" ("+e[b].places.length+")"]=c});var v=u.length-1,w=new L.Control.Layers(t,{});p.addControl(w),a(".js-dependent").show(),a("#temperature-map-layers").append(w._form),a("#temperature-map .leaflet-control-layers").hide(),a(".leaflet-control-layers-list label input").css("visibility","hidden"),a(".leaflet-control-layers-list label").each(function(b){a(this).data("tMapGroup",u[b]),a(this).find("input").prop("checked",!1)}),a(".leaflet-control-layers-list label").click(function(){p.closePopup(),a(".leaflet-control-layers-list label").removeClass("layer-selector-selected").not(this).find("input").prop("checked",!1),a(this).addClass("layer-selector-selected"),a(this).find("input").prop("checked",!0),a(".temperature-map-layer-data-container").html(r(e[a(this).data("tMapGroup")])),v=a(this).index()}),a(".leaflet-control-layers-list label:last, .leaflet-control-layers-list label:last input").click();var x=function(){v=v>=u.length-1?0:v+1,v==u.length-1&&z.stop(),a(".leaflet-control-layers-list label:eq("+v+") input").click()},y=function(){v=0>=v?u.length-1:v-1,a(".leaflet-control-layers-list label:eq("+v+") input").click()},z=a.timer(x);z.set({time:1500}),a(".player-pause").hide(),a(".player-prev").click(function(a){a.preventDefault(),y()}),a(".player-play").click(function(b){b.preventDefault(),v=-1,z.play(!0),x(),a(".player-pause").show(),a(this).hide()}),a(".player-pause").click(function(b){b.preventDefault(),z.pause(),a(".player-play").show(),a(this).hide()}),a(".player-stop").click(function(b){b.preventDefault(),z.stop(),a(".player-play").show(),a(".player-pause").hide()}),a(".player-next").click(function(a){a.preventDefault(),x()}),a("#temperature-map-stats").html("So far, <strong>"+d.length+"</strong> temperature records at Minnesota's major airports have been broken in 2012.")}var e="http://mp-jsonproxy.herokuapp.com/proxy?callback=?&url=",f=b.dataPath||"./data/",g={};c(["noaa-mi3-station-data-mn-trimmed","broken_temperature_record_from_pbs-2012-mn"]).done(d)}}(jQuery);